version: '3.7'

services:
  gateway-db:
    image: postgres
    restart: unless-stopped
    environment:
      POSTGRES_PASSWORD: pass123
    volumes:
      - ./.stored_data/gatewaydb:/var/lib/postgres
    expose:
      - 5432

  gateway:
    image: hbpmip/gateway:${GATEWAY}
    environment:
      - DB_HOST=gateway-db
      - ENGINE_TYPE=exareme
      - ENGINE_BASE_URL=http://172.17.0.1:8080/services/
      - AUTH_SKIP=true
      - AUTH_ENABLE_SSO=false
#      - AUTH_ENABLE_SSO=true         # Should be enabled for Keycloak
      - BASE_URL_CONTEXT=services
      - GATEWAY_PORT=8081
      - CACHE_ENABLED=false
      - NODE_ENV=development
    links:
      - gateway-db
    depends_on:
      - gateway-db
    expose:
      - '8081'
    restart: unless-stopped

  frontend:
    image: hbpmip/portal-frontend:${FRONTEND}
    depends_on:
      - gateway
    ports:
      - '80:80'
      - '443:443'
    volumes:
      - ../../config/caddy/Caddyfile:/etc/caddy/Caddyfile
      - ./.stored_data/caddy/caddy_data:/data
    environment:
      INSTANCE_NAME: 'MIP ${MIP}'
      VERSION: 'Frontend: ${FRONTEND}, Gateway: ${GATEWAY}, Backend: ${PORTALBACKEND}, Exareme1: ${EXAREME}, Exareme2: ${EXAREME2}'
      ERROR_LOG_LEVEL: info
      PORTAL_BACKEND_SERVER: 172.17.0.1:8080
      PORTAL_BACKEND_CONTEXT: services
      GATEWAY_SERVER: gateway:8081
      PUBLIC_MIP_HOST: 172.17.0.1
      PUBLIC_MIP_PROTOCOL: http
      EXTERNAL_MIP_PROTOCOL: http
      KEYCLOAK_HOST: http://keycloak:8095
      KEYCLOAK_AUTH_PATH: /auth
      PORTALBACKEND_AUTH_URL: /oauth2/authorization/keycloak
      MIP_LINK: direct
    restart: unless-stopped

#  keycloak_db:
#    image: postgres:12.2
#    volumes:
#      - ./.stored_data/keycloak:/var/lib/postgresql/data
#    environment:
#      POSTGRES_DB: keycloak
#      POSTGRES_USER: keycloak
#      POSTGRES_PASSWORD: password
#    restart: unless-stopped
#
#  keycloak:
#    image: jboss/keycloak:15.0.2
#    command: -Djboss.http.port=8095
#    volumes:
#      - ../../config/keycloak/keycloak.json:/tmp/mip.json
#      - ../../config/keycloak/HBPTheme:/opt/jboss/keycloak/themes/HBPTheme
#    environment:
#      DB_VENDOR: POSTGRES
#      DB_ADDR: keycloak_db
#      DB_PORT: 5432
#      DB_DATABASE: keycloak
#      DB_USER: keycloak
#      DB_SCHEMA: public
#      DB_PASSWORD: password
#      KEYCLOAK_USER: admin
#      KEYCLOAK_PASSWORD: Pa55w0rd
#      KEYCLOAK_IMPORT: /tmp/mip.json
#      KEYCLOAK_HOSTNAME: 172.17.0.1
#      PROXY_ADDRESS_FORWARDING: 'true'  #important for reverse proxy
#    ports:
#      - '8095:8095'
#      - '8443:8443'
#    depends_on:
#      - keycloak_db
#    restart: unless-stopped
